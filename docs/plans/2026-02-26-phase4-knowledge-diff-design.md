# Phase 4: Knowledge Diff — Design

## Problem

Phase 4 (Knowledge Diff) is described in audit-mode.md but not implemented.
The CLI tool only extracts raw statements. Question generation, probing,
classification, CCS integration, and removal diffs do not exist.

## Approach: CLI Preprocessing + Skill Orchestration (Option B)

CLI generates batched probe prompts (testable, deterministic).
Skill orchestrates sub-agent calls via Task tool and processes results.

## Architecture

```
knowledge-probe.mjs
  ├─ extractStatements(markdown) → string[]          (existing)
  └─ buildProbeBatches(statements, batchSize?) → Batch[]  (new)

audit-mode.md (Phase 4 section)
  ├─ Step 1: CLI --extract --batch → Batch[]
  ├─ Step 2: Task tool per batch → Classification[]
  ├─ Step 3: Aggregate results
  ├─ Step 4: Add duplicate_info to CCS report
  └─ Step 5: Generate removal diffs, request approval
```

## CLI Changes: knowledge-probe.mjs

### New export

```js
export function buildProbeBatches(statements, batchSize = 10)
```

Returns:

```json
[
  {
    "batch_id": 1,
    "statements": ["stmt1", "stmt2", ...],
    "prompt": "You are a knowledge probe agent..."
  }
]
```

- Pure function, no side effects, fully testable.
- Batch size default: 10 statements per batch.
- Simple sequential split (no semantic grouping).

### New CLI flag: --batch

```bash
node knowledge-probe.mjs --root . --extract          # string[] (existing)
node knowledge-probe.mjs --root . --extract --batch   # Batch[] (new)
```

### Prompt template (constant in code)

```
You are a knowledge probe agent testing whether context file statements
contain information an AI coding assistant would already know.

RULES:
- Use ONLY your training knowledge. Do NOT read any project files.
- Do NOT assume any project-specific details.
- For each statement:
  1. Convert it into a neutral question that does NOT reveal the answer
  2. Answer that question from your general knowledge
  3. Compare your answer to the original statement
  4. Classify: REDUNDANT | UNIQUE | REVIEW

CLASSIFICATION:
- REDUNDANT: Your answer matches the statement (AI already knows this)
- UNIQUE: Your answer differs or you cannot answer (project-specific knowledge)
- REVIEW: Partial match (needs human decision)

Statements:
{numbered_statements}

Respond ONLY with a JSON array:
[
  {
    "statement": "original text",
    "question": "neutral question you generated",
    "answer": "your knowledge-based answer",
    "classification": "REDUNDANT",
    "reason": "brief explanation"
  }
]
```

## Skill Changes: audit-mode.md Phase 4

### Step 1: Extract batched prompts

```bash
node ${CLAUDE_PLUGIN_ROOT}/tools/knowledge-probe.mjs --root . --extract --batch
```

### Step 2: Probe sub-agents

For each batch, spawn a Task tool sub-agent:
- subagent_type: general-purpose
- prompt: batch.prompt (generated by CLI)
- Sub-agent responds with classification JSON

### Step 3: Aggregate

Merge all batch results. Group by classification.

### Step 4: CCS integration

Add `duplicate_info` factor to the CCS report (skill-level, not in ccs-score.mjs):

| REDUNDANT count | Score |
|-----------------|-------|
| 1-3             | +1    |
| 4-7             | +2    |
| 8+              | +3    |

### Step 5: User report + diffs

- REDUNDANT: Show removal diff, request approval per item
- REVIEW: Present to user for decision (in user's language)
- UNIQUE: Mark as "keep"
- Apply only approved removals

## Tests

### Unit tests (knowledge-probe.test.mjs)

| Test | Description |
|------|-------------|
| buildProbeBatches basic | 12 stmts → 2 batches (10+2) |
| empty array | [] → [] |
| custom batchSize | batchSize=5 → 3 batches for 12 stmts |
| prompt format | Each batch.prompt contains numbered statements |
| output structure | batch_id, statements, prompt fields exist |

### CLI tests (cli.test.mjs)

| Test | Description |
|------|-------------|
| --extract --batch | Outputs Batch[] JSON |
| --extract only | Still outputs string[] (backward compat) |

### Not testable (skill-level)

- Sub-agent response quality (depends on model)
- CCS integration (skill adds factor at report time)
- Diff generation (skill generates based on classification)

## Files to modify

| File | Action |
|------|--------|
| tools/knowledge-probe.mjs | ADD buildProbeBatches, --batch flag |
| skills/context-architect/audit-mode.md | REWRITE Phase 4 section |
| tests/tools/knowledge-probe.test.mjs | ADD buildProbeBatches tests |
| tests/tools/cli.test.mjs | ADD --batch CLI test |
| README.md | UPDATE Phase 4 description |

## Out of scope

- External API calls from CLI (no API key dependency)
- Semantic statement grouping (YAGNI — sequential split is sufficient)
- ccs-score.mjs changes (CCS integration is skill-level only)
